<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mj-WhatsApp Ultimate</title>
    
    <link rel="icon" type="image/png" href="logo-mj-whatsapp.png">
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css">
    
    <style>
        :root { --wa-bg: #0b141a; --wa-nav: #202c33; --wa-green: #00a884; --wa-msg-me: #005c4b; --wa-msg-him: #202c33; }
        body { background: var(--wa-bg); color: #e9edef; font-family: 'Segoe UI', sans-serif; height: 100dvh; margin: 0; overflow: hidden; }

        /* UI SCREENS */
        #screen-login, #screen-home, #chat-window { position: fixed; inset: 0; display: none; flex-direction: column; }
        .nav-header { background: var(--wa-nav); padding: 15px; display: flex; justify-content: space-between; align-items: center; }

        /* VIDEO CALL UI */
        #video-call-overlay { position: fixed; inset: 0; background: black; z-index: 5000; display: none; flex-direction: column; }
        .remote-video { width: 100%; height: 100%; object-fit: cover; }
        .local-video { width: 120px; height: 160px; position: absolute; top: 20px; right: 20px; border-radius: 10px; border: 2px solid var(--wa-green); object-fit: cover; z-index: 5001; }
        .call-controls { position: absolute; bottom: 40px; width: 100%; display: flex; justify-content: center; gap: 30px; z-index: 5002; }
        .btn-end-call { background: #ff3b30; width: 60px; height: 60px; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: none; color: white; }

        /* CHAT BUBBLE */
        #chat-messages { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 10px; background-color: #0d1418; }
        .msg { max-width: 80%; padding: 10px; border-radius: 12px; font-size: 0.95rem; color: white; }
        .msg.me { align-self: flex-end; background: var(--wa-msg-me); }
        .msg.him { align-self: flex-start; background: var(--wa-msg-him); }

        /* INPUT AREA */
        .chat-input-area { background: var(--wa-nav); padding: 12px; display: flex; gap: 10px; align-items: center; }
        .chat-input-area input { flex: 1; background: #2a3942; border: none; color: white; border-radius: 25px; padding: 10px 15px; }
        .btn-vn { background: none; border: none; color: #8696a0; font-size: 1.5rem; transition: 0.3s; }
        .btn-vn.recording { color: #ff3b30; transform: scale(1.3); }
    </style>
</head>
<body>

<div id="video-call-overlay">
    <video id="remote-video" class="remote-video" autoplay playsinline></video>
    <video id="local-video" class="local-video" autoplay muted playsinline></video>
    <div class="call-controls">
        <button class="btn-end-call" onclick="endCall()">‚ùå</button>
    </div>
</div>

<div id="screen-login" class="justify-content-center p-4 text-center">
    <h2 class="text-success fw-bold">Mj-WhatsApp</h2>
    <input type="text" id="username-input" class="form-control mb-3" placeholder="Nama..." style="background:#2a3942;color:white;border:none;">
    <button class="btn btn-success w-100" onclick="handleLogin()">MASUK</button>
</div>

<div id="screen-home">
    <div class="nav-header">
        <b>Mj-WhatsApp</b>
        <button class="btn btn-sm btn-outline-danger" onclick="clearIdentity()">Hapus User</button>
    </div>
    <div id="contact-list" class="flex-grow-1 overflow-auto p-2"></div>
</div>

<div id="chat-window">
    <div class="nav-header">
        <div class="d-flex align-items-center">
            <button onclick="closeChat()" class="btn text-white p-0 me-3">‚Üê</button>
            <b id="chat-with-name"></b>
        </div>
        <button onclick="startVideoCall()" style="background:none;border:none;font-size:1.5rem;">üìπ</button>
    </div>
    <div id="chat-messages"></div>
    <div class="chat-input-area">
        <input type="text" id="text-msg" placeholder="Pesan..." onkeypress="if(event.key==='Enter') sendText()">
        <button id="vn-btn" class="btn-vn" onmousedown="startVN()" onmouseup="stopVN()" ontouchstart="startVN()" ontouchend="stopVN()">üé§</button>
        <button onclick="sendText()" class="btn btn-success rounded-circle">‚û§</button>
    </div>
</div>

<audio id="notif-sound" src="https://assets.mixkit.co/active_storage/sfx/2358/2358-preview.mp3"></audio>

<script>
    const REPO = "hamudi2012/Mj-WhatApp"; 
    const peer = new Peer();
    let myName = localStorage.getItem('mj_user'), targetPeerId, targetName, currentCall;
    let mediaRecorder, audioChunks = [];

    window.onload = () => { 
        if (myName) { goToHome(); } else { document.getElementById('screen-login').style.display='flex'; }
    };

    function goToHome() { 
        document.getElementById('screen-home').style.display='flex';
        fetchContacts(); setInterval(fetchContacts, 5000);
    }

    function handleLogin() {
        const val = document.getElementById('username-input').value.trim();
        const key = localStorage.getItem('_mj_wa_tkn') || new URLSearchParams(window.location.search).get('key');
        if(!val || !key) return alert("Butuh Nama & Token!");
        localStorage.setItem('mj_user', val); localStorage.setItem('_mj_wa_tkn', key);
        location.reload();
    }

    function clearIdentity() { localStorage.removeItem('mj_user'); location.reload(); }

    // PEER LOGIC
    peer.on('open', id => { if(myName) syncContact(myName, id); });

    // TERIMA VIDEO CALL
    peer.on('call', call => {
        if(confirm("Video Call Masuk! Angkat?")) {
            navigator.mediaDevices.getUserMedia({video: true, audio: true}).then(stream => {
                document.getElementById('video-call-overlay').style.display = 'flex';
                document.getElementById('local-video').srcObject = stream;
                call.answer(stream);
                call.on('stream', remoteStream => {
                    document.getElementById('remote-video').srcObject = remoteStream;
                });
                currentCall = call;
            });
        }
    });

    // TERIMA DATA (TEXT / VOICE NOTE)
    peer.on('connection', conn => {
        conn.on('data', data => {
            if(data.type === 'text') {
                saveMsg(data.sender, data.sender, data.val, 'him', 'text');
                if(targetName === data.sender) appendUI(data.sender, data.val, 'him', 'text');
            } else if (data.type === 'vn') {
                saveMsg(data.sender, data.sender, data.val, 'him', 'vn');
                if(targetName === data.sender) appendUI(data.sender, data.val, 'him', 'vn');
            }
            document.getElementById('notif-sound').play();
        });
    });

    // FITUR VIDEO CALL
    function startVideoCall() {
        navigator.mediaDevices.getUserMedia({video: true, audio: true}).then(stream => {
            document.getElementById('video-call-overlay').style.display = 'flex';
            document.getElementById('local-video').srcObject = stream;
            const call = peer.call(targetPeerId, stream);
            call.on('stream', remoteStream => {
                document.getElementById('remote-video').srcObject = remoteStream;
            });
            currentCall = call;
        });
    }

    function endCall() {
        if(currentCall) currentCall.close();
        document.getElementById('video-call-overlay').style.display = 'none';
        location.reload();
    }

    // FITUR VOICE NOTE
    function startVN() {
        navigator.mediaDevices.getUserMedia({ audio: true }).then(stream => {
            mediaRecorder = new MediaRecorder(stream);
            mediaRecorder.start();
            audioChunks = [];
            document.getElementById('vn-btn').classList.add('recording');
            mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
        });
    }

    function stopVN() {
        if(!mediaRecorder) return;
        mediaRecorder.stop();
        document.getElementById('vn-btn').classList.remove('recording');
        mediaRecorder.onstop = () => {
            const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
            const reader = new FileReader();
            reader.readAsDataURL(audioBlob);
            reader.onloadend = () => {
                const base64Audio = reader.result;
                sendData(base64Audio, 'vn');
                appendUI(myName, base64Audio, 'me', 'vn');
            };
        };
    }

    function sendText() {
        const val = document.getElementById('text-msg').value.trim();
        if(!val) return;
        sendData(val, 'text');
        appendUI(myName, val, 'me', 'text');
        document.getElementById('text-msg').value = "";
    }

    function sendData(val, type) {
        saveMsg(targetName, myName, val, 'me', type);
        const conn = peer.connect(targetPeerId);
        conn.on('open', () => { conn.send({ type, sender: myName, val }); });
    }

    function appendUI(s, t, side, type) {
        const box = document.getElementById('chat-messages');
        const div = document.createElement('div');
        div.className = `msg ${side}`;
        if(type === 'text') {
            div.innerHTML = `<small class="text-success fw-bold">${s}</small><div>${t}</div>`;
        } else {
            div.innerHTML = `<small class="text-success fw-bold">${s}</small><br><audio controls src="${t}" style="width:200px; height:30px;"></audio>`;
        }
        box.appendChild(div);
        box.scrollTop = box.scrollHeight;
    }

    // LOCAL STORAGE PERSISTENCE
    function saveMsg(chatWith, sender, text, side, type) {
        let h = JSON.parse(localStorage.getItem('chat_'+chatWith) || "[]");
        h.push({sender, text, side, type});
        localStorage.setItem('chat_'+chatWith, JSON.stringify(h));
    }

    async function fetchContacts() {
        try {
            const res = await fetch(`https://hamudi2012.github.io/Mj-WhatApp/contacts.json?t=${Date.now()}`);
            const data = await res.json();
            const list = document.getElementById('contact-list'); list.innerHTML = "";
            for(let n in data) {
                if(n === myName) continue;
                const div = document.createElement('div');
                div.className = "p-3 border-bottom d-flex align-items-center gap-3";
                div.onclick = () => {
                    targetName = n; targetPeerId = data[n];
                    document.getElementById('chat-window').style.display='flex';
                    document.getElementById('chat-with-name').innerText = n;
                    loadHistory(n);
                };
                div.innerHTML = `<div style="width:40px;height:40px;background:var(--wa-green);border-radius:50%;text-align:center;line-height:40px;font-weight:bold;">${n[0].toUpperCase()}</div><b>${n}</b>`;
                list.appendChild(div);
            }
        } catch(e){}
    }

    function loadHistory(chatWith) {
        const box = document.getElementById('chat-messages'); box.innerHTML = "";
        let h = JSON.parse(localStorage.getItem('chat_'+chatWith) || "[]");
        h.forEach(m => appendUI(m.sender, m.text, m.side, m.type));
    }

    function closeChat() { document.getElementById('chat-window').style.display='none'; }

    async function syncContact(n, id) {
        const t = localStorage.getItem('_mj_wa_tkn');
        try {
            const r = await fetch(`https://api.github.com/repos/${REPO}/contents/contacts.json`, {headers:{'Authorization':`token ${t}`}});
            const d = await r.json(); 
            const c = JSON.parse(atob(d.content)); c[n]=id;
            await fetch(`https://api.github.com/repos/${REPO}/contents/contacts.json`, {
                method:'PUT', headers:{'Authorization':`token ${t}`}, 
                body:JSON.stringify({message:"Update ID", content:btoa(JSON.stringify(c)), sha:d.sha})
            });
        } catch(e){}
    }
</script>
</body>
</html>
