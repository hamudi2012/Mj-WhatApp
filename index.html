<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mj-WhatsApp Pro v2</title>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
    
    <style>
        :root { 
            --wa-bg: #0b141a; 
            --wa-nav: #202c33; 
            --wa-green: #00a884; 
            --wa-card: #111b21;
            --wa-text: #e9edef;
            --wa-muted: #8696a0;
        }

        body { background: var(--wa-bg); color: var(--wa-text); font-family: 'Segoe UI', sans-serif; height: 100dvh; margin: 0; overflow: hidden; }

        /* MODAL LOGIN / LOGOUT */
        .auth-screen { 
            position: fixed; inset: 0; background: var(--wa-bg); z-index: 9999; 
            display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px;
        }

        /* CONTACT LIST GILA */
        .contact-card {
            background: var(--wa-card); margin: 8px 12px; padding: 15px; border-radius: 16px;
            display: flex; align-items: center; gap: 15px; transition: 0.2s;
            border: 1px solid transparent; cursor: pointer;
        }
        .contact-card:hover { border-color: var(--wa-green); background: #1d2a33; transform: scale(1.02); }
        .avatar-box { 
            width: 55px; height: 55px; border-radius: 50%; background: linear-gradient(45deg, var(--wa-green), #00e676);
            display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 1.2rem; color: white;
        }
        .online-dot { width: 12px; height: 12px; background: #00e676; border-radius: 50%; border: 2px solid var(--wa-card); position: absolute; bottom: 0; right: 0; }

        /* CHAT AREA */
        #chat-window { position: fixed; inset: 0; background: #0b141a; z-index: 2000; display: none; flex-direction: column; }
        #chat-messages { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 5px; }
        
        /* BUBBLE FAST */
        .msg { max-width: 80%; padding: 8px 12px; border-radius: 12px; font-size: 0.95rem; line-height: 1.4; position: relative; }
        .msg.me { align-self: flex-end; background: #005c4b; border-bottom-right-radius: 2px; }
        .msg.him { align-self: flex-start; background: #202c33; border-bottom-left-radius: 2px; }

        .chat-input-area { background: var(--wa-nav); padding: 12px; display: flex; align-items: center; gap: 10px; }
        .input-box { flex: 1; background: #2a3942; border: none; border-radius: 25px; padding: 10px 18px; color: white; outline: none; }

        .btn-action { background: var(--wa-green); border: none; width: 45px; height: 45px; border-radius: 50%; color: white; display: flex; align-items: center; justify-content: center; }
        
        .status-badge { font-size: 0.7rem; padding: 2px 8px; border-radius: 10px; background: rgba(0, 168, 132, 0.2); color: var(--wa-green); }
    </style>
</head>
<body>

<div id="screen-login" class="auth-screen">
    <span class="material-symbols-outlined" style="font-size: 80px; color: var(--wa-green);">bolt</span>
    <h2 class="fw-bold mt-3">MJ-WHATSAPP</h2>
    <p class="text-secondary mb-4">Fast & Secure Connection</p>
    <div class="w-100" style="max-width: 320px;">
        <input type="text" id="username-input" class="form-control mb-3 shadow-none" placeholder="Masukkan Nama Kamu..." style="background: #2a3942; border: none; color: white; height: 55px; border-radius: 15px;">
        <button class="btn btn-success w-100 fw-bold" onclick="handleLogin()" style="height: 55px; border-radius: 15px; background: var(--wa-green);">MASUK SEKARANG</button>
    </div>
</div>

<div id="screen-home" style="display: none; flex-direction: column; height: 100%;">
    <div class="p-3 d-flex justify-content-between align-items-center" style="background: var(--wa-nav);">
        <div>
            <h4 class="m-0 fw-bold">Mj-WhatsApp</h4>
            <div id="my-status" class="status-badge">Menghubungkan...</div>
        </div>
        <div class="d-flex gap-3">
            <span class="material-symbols-outlined" onclick="handleLogout()" style="color: #ff3b30; cursor: pointer;">logout</span>
        </div>
    </div>
    <div id="contact-list" class="flex-1 overflow-auto pt-2"></div>
</div>

<div id="chat-window">
    <div class="p-3 d-flex align-items-center gap-3" style="background: var(--wa-nav);">
        <span class="material-symbols-outlined" onclick="closeChat()">arrow_back</span>
        <div class="avatar-box" style="width: 40px; height: 40px; font-size: 1rem;" id="chat-avatar">?</div>
        <div class="flex-grow-1">
            <b id="chat-with-name" class="d-block">Nama Teman</b>
            <small class="text-success" style="font-size: 0.7rem;">‚óè Aktif</small>
        </div>
        <span class="material-symbols-outlined" onclick="startCall(targetPeerId)">videocam</span>
    </div>
    <div id="chat-messages"></div>
    <div class="chat-input-area">
        <input type="text" id="text-msg" class="input-box" placeholder="Ketik pesan..." onkeypress="if(event.key==='Enter') sendText()">
        <button class="btn-action" onclick="sendText()">
            <span class="material-symbols-outlined">send</span>
        </button>
    </div>
</div>

<script>
    const REPO = "hamudi2012/Mj-WhatApp"; 
    let peer = null;
    let myName = localStorage.getItem('mj_user');
    let targetPeerId = null;
    let activeConnections = {}; // Cache koneksi supaya ontime

    window.onload = () => {
        if (myName) {
            initPeer();
            goToHome();
        }
    };

    function initPeer() {
        peer = new Peer();
        
        peer.on('open', id => {
            document.getElementById('my-status').innerText = "Online: " + myName;
            syncToGitHub(myName, id);
        });

        // Handler pesan masuk - Langsung eksekusi
        peer.on('connection', conn => {
            activeConnections[conn.peer] = conn;
            conn.on('data', data => {
                if (data.type === 'text') appendMsg(data.sender, data.val, 'him');
            });
        });

        peer.on('call', call => {
            if(confirm("Panggilan video masuk! Angkat?")) {
                navigator.mediaDevices.getUserMedia({video: true, audio: true}).then(stream => {
                    // Logika video call di sini (sama seperti sebelumnya)
                    call.answer(stream);
                });
            }
        });
    }

    function handleLogin() {
        const input = document.getElementById('username-input').value.trim();
        const key = new URLSearchParams(window.location.search).get('key') || localStorage.getItem('_mj_wa_tkn');
        
        if (!input) return alert("Nama tidak boleh kosong!");
        if (!key) return alert("Akses ditolak! Butuh kunci API.");

        localStorage.setItem('mj_user', input);
        localStorage.setItem('_mj_wa_tkn', key);
        myName = input;
        
        initPeer();
        goToHome();
    }

    function handleLogout() {
        if(confirm("Keluar dari akun?")) {
            localStorage.removeItem('mj_user');
            location.reload();
        }
    }

    function goToHome() {
        document.getElementById('screen-login').style.display = 'none';
        document.getElementById('screen-home').style.display = 'flex';
        fetchContacts();
        setInterval(fetchContacts, 5000);
    }

    async function syncToGitHub(name, id) {
        const token = localStorage.getItem('_mj_wa_tkn');
        try {
            const res = await fetch(`https://api.github.com/repos/${REPO}/contents/contacts.json`, {
                headers: { 'Authorization': `token ${token}` }
            });
            const data = await res.json();
            const contacts = JSON.parse(atob(data.content));
            contacts[name] = id;
            await fetch(`https://api.github.com/repos/${REPO}/contents/contacts.json`, {
                method: 'PUT',
                headers: { 'Authorization': `token ${token}` },
                body: JSON.stringify({ 
                    message: "User " + name + " Online", 
                    content: btoa(JSON.stringify(contacts)), 
                    sha: data.sha 
                })
            });
        } catch(e) { console.error("Sync Error"); }
    }

    async function fetchContacts() {
        try {
            const res = await fetch(`https://hamudi2012.github.io/Mj-WhatApp/contacts.json?t=${Date.now()}`);
            const contacts = await res.json();
            const list = document.getElementById('contact-list');
            list.innerHTML = "";
            
            for(let name in contacts) {
                if(name === myName) continue;
                const div = document.createElement('div');
                div.className = "contact-card";
                div.onclick = () => openChat(name, contacts[name]);
                div.innerHTML = `
                    <div style="position:relative">
                        <div class="avatar-box">${name.charAt(0).toUpperCase()}</div>
                        <div class="online-dot"></div>
                    </div>
                    <div class="flex-grow-1">
                        <div class="d-flex justify-content-between">
                            <b class="text-white">${name}</b>
                            <small class="text-muted">Online</small>
                        </div>
                        <p class="m-0 text-muted" style="font-size:0.8rem;">Ketuk untuk mulai chat...</p>
                    </div>
                `;
                list.appendChild(div);
            }
        } catch(e) {}
    }

    function openChat(name, id) {
        targetPeerId = id;
        document.getElementById('chat-with-name').innerText = name;
        document.getElementById('chat-avatar').innerText = name.charAt(0).toUpperCase();
        document.getElementById('chat-window').style.display = 'flex';
        document.getElementById('chat-messages').innerHTML = "";

        // Pre-connect biar ontime
        if (!activeConnections[id]) {
            activeConnections[id] = peer.connect(id);
        }
    }

    function closeChat() { document.getElementById('chat-window').style.display = 'none'; }

    // FUNGSI KIRIM ONTIME (LIVE)
    function sendText() {
        const input = document.getElementById('text-msg');
        const val = input.value.trim();
        if (!val || !targetPeerId) return;

        let conn = activeConnections[targetPeerId];

        const payload = { type: 'text', sender: myName, val: val };

        // Langsung tampilkan di layar sendiri (Instant UI)
        appendMsg(myName, val, 'me');
        input.value = "";

        // Kirim ke lawan bicara
        if (conn && conn.open) {
            conn.send(payload);
        } else {
            // Re-connect jika putus
            conn = peer.connect(targetPeerId);
            conn.on('open', () => {
                conn.send(payload);
                activeConnections[targetPeerId] = conn;
            });
        }
    }

    function appendMsg(sender, text, side) {
        const div = document.createElement('div');
        div.className = `msg ${side}`;
        div.innerHTML = `
            ${side === 'him' ? `<small style="color:var(--wa-green); font-size:0.7rem; font-weight:bold;">${sender}</small><br>` : ''}
            ${text}
            <div style="font-size:0.6rem; opacity:0.6; text-align:right; margin-top:3px;">
                ${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}
            </div>
        `;
        const container = document.getElementById('chat-messages');
        container.appendChild(div);
        container.scrollTo(0, container.scrollHeight);
    }
</script>
</body>
</html>
