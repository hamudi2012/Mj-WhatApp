<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mj-WhatsApp Pro v4</title>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    
    <style>
        :root { 
            --wa-bg: #0b141a; --wa-nav: #202c33; --wa-green: #00a884; 
            --wa-card: #111b21; --wa-text: #e9edef; --wa-muted: #8696a0;
            --wa-me: #005c4b; --wa-him: #202c33;
        }

        body { 
            background: var(--wa-bg); color: var(--wa-text); 
            font-family: 'Segoe UI', Roboto, sans-serif; 
            height: 100dvh; margin: 0; overflow: hidden; 
        }

        /* SCREEN LOGIN */
        .auth-screen { 
            position: fixed; inset: 0; background: var(--wa-bg); z-index: 9999; 
            display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px;
        }

        /* CONTACT LIST GILA */
        .contact-card {
            background: var(--wa-card); margin: 10px 15px; padding: 15px; border-radius: 18px;
            display: flex; align-items: center; gap: 15px; transition: 0.3s;
            border: 1px solid #222d34; cursor: pointer;
        }
        .contact-card:active { transform: scale(0.95); background: #1d2a33; }
        .avatar-box { 
            width: 55px; height: 55px; border-radius: 50%; 
            background: linear-gradient(45deg, #00a884, #00e676);
            display: flex; align-items: center; justify-content: center; 
            font-weight: bold; font-size: 1.3rem; color: white;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }

        /* CHAT WINDOW */
        #chat-window { position: fixed; inset: 0; background: #0b141a; z-index: 2000; display: none; flex-direction: column; }
        #chat-messages { 
            flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 8px; 
            background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png');
            background-blend-mode: overlay;
        }
        
        .msg { max-width: 80%; padding: 8px 12px; border-radius: 12px; font-size: 0.95rem; position: relative; }
        .msg.me { align-self: flex-end; background: var(--wa-me); border-bottom-right-radius: 2px; }
        .msg.him { align-self: flex-start; background: var(--wa-him); border-bottom-left-radius: 2px; }
        .msg-time { font-size: 0.65rem; opacity: 0.6; text-align: right; margin-top: 4px; }

        .chat-input-area { background: var(--wa-nav); padding: 12px; display: flex; align-items: center; gap: 10px; }
        .input-box { 
            flex: 1; background: #2a3942; border: none; border-radius: 25px; 
            padding: 10px 18px; color: white; outline: none; 
        }

        .btn-action { 
            background: var(--wa-green); border: none; width: 48px; height: 48px; 
            border-radius: 50%; color: white; display: flex; align-items: center; justify-content: center; 
        }

        .icon { font-family: 'Material Symbols Outlined'; cursor: pointer; user-select: none; }
    </style>
</head>
<body>

<div id="screen-login" class="auth-screen">
    <span class="icon" style="font-size: 100px; color: var(--wa-green);">account_circle</span>
    <h2 class="fw-bold mt-3">MJ-WHATSAPP</h2>
    <div class="w-100 mt-4" style="max-width: 320px;">
        <input type="text" id="username-input" class="form-control mb-3" placeholder="Masukkan Nama..." style="background: #2a3942; border: none; color: white; height: 55px; border-radius: 15px;">
        <button class="btn btn-success w-100 fw-bold" onclick="handleLogin()" style="height: 55px; border-radius: 15px; background: var(--wa-green);">MASUK</button>
    </div>
</div>

<div id="screen-home" style="display: none; flex-direction: column; height: 100%;">
    <div class="p-3 d-flex justify-content-between align-items-center" style="background: var(--wa-nav);">
        <h4 class="m-0 fw-bold">Mj-WhatsApp</h4>
        <div class="d-flex gap-3">
            <span class="icon" onclick="handleLogout()" style="color: #ff3b30;">logout</span>
        </div>
    </div>
    <div id="contact-list" class="flex-1 overflow-auto pt-2"></div>
</div>

<div id="chat-window">
    <div class="p-3 d-flex align-items-center gap-3" style="background: var(--wa-nav);">
        <span class="icon" onclick="closeChat()">arrow_back</span>
        <div class="avatar-box" style="width: 40px; height: 40px; font-size: 1rem;" id="chat-avatar">?</div>
        <div class="flex-grow-1">
            <b id="chat-with-name" class="d-block">Nama Teman</b>
            <small class="text-success" style="font-size: 0.7rem;">Online</small>
        </div>
        <span class="icon" style="color: #00e676;" onclick="syncChatToCloud()">cloud_upload</span>
        <span class="icon" style="color: #ff3b30;" onclick="clearHistory()">delete</span>
    </div>
    <div id="chat-messages"></div>
    <div class="chat-input-area">
        <input type="text" id="text-msg" class="input-box" placeholder="Ketik pesan..." onkeypress="if(event.key==='Enter') sendText()">
        <button class="btn-action" onclick="sendText()">
            <span class="icon">send</span>
        </button>
    </div>
</div>

<script>
    const REPO = "hamudi2012/Mj-WhatApp"; 
    let peer = null, myName = localStorage.getItem('mj_user'), targetPeerId = null, targetName = "";
    let activeConnections = {};

    window.onload = () => { if (myName) { initPeer(); goToHome(); } };

    function initPeer() {
        peer = new Peer();
        peer.on('open', id => syncToGitHub(myName, id));
        peer.on('connection', conn => {
            activeConnections[conn.peer] = conn;
            conn.on('data', data => {
                if (data.type === 'text') {
                    saveMessage(data.sender, data.sender, data.val, 'him');
                    if(targetName === data.sender) appendMsg(data.sender, data.val, 'him');
                }
            });
        });
    }

    // DATABASE & HISTORY LOGIC
    function saveMessage(chatWith, sender, text, side) {
        let history = JSON.parse(localStorage.getItem('mj_chat_' + chatWith) || "[]");
        history.push({ sender, text, side, time: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) });
        localStorage.setItem('mj_chat_' + chatWith, JSON.stringify(history));
    }

    function loadHistory(chatWith) {
        const container = document.getElementById('chat-messages');
        container.innerHTML = "";
        let history = JSON.parse(localStorage.getItem('mj_chat_' + chatWith) || "[]");
        history.forEach(m => appendMsg(m.sender, m.text, m.side, m.time));
    }

    function clearHistory() {
        if(confirm(`Hapus chat dengan ${targetName}?`)) {
            localStorage.removeItem('mj_chat_' + targetName);
            loadHistory(targetName);
        }
    }

    // CLOUD SYNC (DATABASE GITHUB)
    async function syncChatToCloud() {
        const token = localStorage.getItem('_mj_wa_tkn');
        const history = localStorage.getItem('mj_chat_' + targetName);
        if (!history || history === "[]") return alert("Belum ada chat!");
        
        try {
            const fileName = `chats/${myName}_to_${targetName}.json`;
            const res = await fetch(`https://api.github.com/repos/${REPO}/contents/${fileName}`, {
                headers: { 'Authorization': `token ${token}` }
            });
            let sha = res.ok ? (await res.json()).sha : undefined;

            const upload = await fetch(`https://api.github.com/repos/${REPO}/contents/${fileName}`, {
                method: 'PUT',
                headers: { 'Authorization': `token ${token}` },
                body: JSON.stringify({ message: "Backup Chat", content: btoa(history), sha })
            });
            if (upload.ok) alert("Berhasil Backup ke Cloud!");
        } catch (e) { alert("Gagal Backup!"); }
    }

    async function restoreFromCloud(name) {
        const token = localStorage.getItem('_mj_wa_tkn');
        try {
            const res = await fetch(`https://hamudi2012.github.io/Mj-WhatApp/chats/${myName}_to_${name}.json?t=${Date.now()}`);
            if (res.ok) {
                const data = await res.json();
                localStorage.setItem('mj_chat_' + name, atob(data.content));
            }
        } catch (e) {}
    }

    // CORE FUNCTIONS
    function sendText() {
        const input = document.getElementById('text-msg');
        const val = input.value.trim();
        if (!val || !targetPeerId) return;

        saveMessage(targetName, myName, val, 'me');
        appendMsg(myName, val, 'me');
        input.value = "";

        let conn = activeConnections[targetPeerId];
        if (conn && conn.open) {
            conn.send({ type: 'text', sender: myName, val });
        } else {
            conn = peer.connect(targetPeerId);
            conn.on('open', () => conn.send({ type: 'text', sender: myName, val }));
            activeConnections[targetPeerId] = conn;
        }
    }

    function appendMsg(sender, text, side, time = null) {
        const div = document.createElement('div');
        div.className = `msg ${side}`;
        const timestamp = time || new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        div.innerHTML = `${text}<div class="msg-time">${timestamp}</div>`;
        const container = document.getElementById('chat-messages');
        container.appendChild(div);
        container.scrollTop = container.scrollHeight;
    }

    function handleLogin() {
        const input = document.getElementById('username-input').value.trim();
        const key = new URLSearchParams(window.location.search).get('key') || localStorage.getItem('_mj_wa_tkn');
        if (!input || !key) return alert("Isi Nama & Gunakan Link Token!");
        localStorage.setItem('mj_user', input);
        localStorage.setItem('_mj_wa_tkn', key);
        location.reload();
    }

    function handleLogout() { if(confirm("Logout?")) { localStorage.removeItem('mj_user'); location.reload(); } }

    function goToHome() {
        document.getElementById('screen-login').style.display = 'none';
        document.getElementById('screen-home').style.display = 'flex';
        fetchContacts();
        setInterval(fetchContacts, 7000);
    }

    async function fetchContacts() {
        try {
            const res = await fetch(`https://hamudi2012.github.io/Mj-WhatApp/contacts.json?t=${Date.now()}`);
            const contacts = await res.json();
            const list = document.getElementById('contact-list');
            list.innerHTML = "";
            for(let name in contacts) {
                if(name === myName) continue;
                const div = document.createElement('div');
                div.className = "contact-card";
                div.onclick = async () => {
                    targetName = name; targetPeerId = contacts[name];
                    document.getElementById('chat-with-name').innerText = name;
                    document.getElementById('chat-avatar').innerText = name.charAt(0).toUpperCase();
                    document.getElementById('chat-window').style.display = 'flex';
                    await restoreFromCloud(name);
                    loadHistory(name);
                };
                div.innerHTML = `<div class="avatar-box">${name.charAt(0).toUpperCase()}</div><div class="flex-grow-1"><b>${name}</b><br><small class="text-muted">Ketuk untuk chat</small></div><span class="icon" style="color:var(--wa-green)">chevron_right</span>`;
                list.appendChild(div);
            }
        } catch(e) {}
    }

    function closeChat() { document.getElementById('chat-window').style.display = 'none'; targetName = ""; }

    async function syncToGitHub(name, id) {
        const token = localStorage.getItem('_mj_wa_tkn');
        try {
            const res = await fetch(`https://api.github.com/repos/${REPO}/contents/contacts.json`, { headers: { 'Authorization': `token ${token}` } });
            const data = await res.json();
            const contacts = JSON.parse(atob(data.content));
            contacts[name] = id;
            await fetch(`https://api.github.com/repos/${REPO}/contents/contacts.json`, {
                method: 'PUT',
                headers: { 'Authorization': `token ${token}` },
                body: JSON.stringify({ message: "User Online", content: btoa(JSON.stringify(contacts)), sha: data.sha })
            });
        } catch(e) {}
    }
</script>
</body>
</html>
